{"cells":[{"cell_type":"markdown","metadata":{"id":"e0gVxm2K9N0n"},"source":["## 1. Set-up"]},{"cell_type":"markdown","metadata":{"id":"iwXz00Yqj0Wj"},"source":["### Drive and Path"]},{"cell_type":"code","execution_count":null,"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"executionInfo":{"elapsed":3685,"status":"ok","timestamp":1713032852409,"user":{"displayName":"Jac","userId":"11093024635147897716"},"user_tz":-540},"id":"WsrpBvAq9IYt","outputId":"b8d86c49-e974-428b-a9bf-3eddb42dba30"},"outputs":[{"output_type":"stream","name":"stdout","text":["Drive already mounted at /content/drive; to attempt to forcibly remount, call drive.mount(\"/content/drive\", force_remount=True).\n"]}],"source":["#mount google drive\n","from google.colab import drive\n","drive.mount('/content/drive')"]},{"cell_type":"code","execution_count":null,"metadata":{"id":"u6pcqyuA9afE"},"outputs":[],"source":["#set file path\n","project_path = \"/content/drive/MyDrive/266 Project/\"\n","image_path = project_path+\"pokemon_png/\"\n","caption_path = project_path+\"pokemon_caption.csv\""]},{"cell_type":"markdown","metadata":{"id":"9wF5VG8Rj4aQ"},"source":["### Import libraries"]},{"cell_type":"code","execution_count":null,"metadata":{"id":"UCP-u-tUBnOM"},"outputs":[],"source":["#libraries\n","import string, os, re, pickle\n","import numpy as np\n","import pandas as pd\n","\n","from IPython.display import Image, display\n","\n","from sklearn.utils import shuffle\n","from sklearn.model_selection import train_test_split\n","\n","import tensorflow as tf\n","from tensorflow import keras\n","\n","from keras.layers import Embedding, Input, Dense, Lambda, BatchNormalization, LSTM, Dropout, RepeatVector, TimeDistributed, Bidirectional, add, concatenate\n","from keras.models import Model, load_model\n","from keras.preprocessing.sequence import pad_sequences\n","from keras.callbacks import ModelCheckpoint, EarlyStopping, ReduceLROnPlateau\n","from keras.preprocessing.image import load_img, img_to_array\n","from keras.preprocessing.text import Tokenizer\n","from keras.applications.inception_v3 import InceptionV3\n","from keras.applications.vgg16 import preprocess_input\n","from keras.utils import to_categorical, plot_model\n"]},{"cell_type":"code","execution_count":null,"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"executionInfo":{"elapsed":35658,"status":"ok","timestamp":1713032899608,"user":{"displayName":"Jac","userId":"11093024635147897716"},"user_tz":-540},"id":"XeqnAJQ_DWmK","outputId":"769de78a-6ff3-4f55-c112-8f773bb43bcc"},"outputs":[{"output_type":"stream","name":"stdout","text":["Requirement already satisfied: aac-metrics in /usr/local/lib/python3.10/dist-packages (0.5.4)\n","Requirement already satisfied: numpy>=1.21.2 in /usr/local/lib/python3.10/dist-packages (from aac-metrics) (1.25.2)\n","Requirement already satisfied: packaging>=23 in /usr/local/lib/python3.10/dist-packages (from aac-metrics) (24.0)\n","Requirement already satisfied: pyyaml>=6.0 in /usr/local/lib/python3.10/dist-packages (from aac-metrics) (6.0.1)\n","Requirement already satisfied: sentence-transformers>=2.2.2 in /usr/local/lib/python3.10/dist-packages (from aac-metrics) (2.6.1)\n","Requirement already satisfied: torch>=1.10.1 in /usr/local/lib/python3.10/dist-packages (from aac-metrics) (2.2.1+cu121)\n","Requirement already satisfied: torchmetrics>=0.11.4 in /usr/local/lib/python3.10/dist-packages (from aac-metrics) (1.3.2)\n","Requirement already satisfied: tqdm>=4.64.0 in /usr/local/lib/python3.10/dist-packages (from aac-metrics) (4.66.2)\n","Requirement already satisfied: transformers in /usr/local/lib/python3.10/dist-packages (from aac-metrics) (4.38.2)\n","Requirement already satisfied: scikit-learn in /usr/local/lib/python3.10/dist-packages (from sentence-transformers>=2.2.2->aac-metrics) (1.2.2)\n","Requirement already satisfied: scipy in /usr/local/lib/python3.10/dist-packages (from sentence-transformers>=2.2.2->aac-metrics) (1.11.4)\n","Requirement already satisfied: huggingface-hub>=0.15.1 in /usr/local/lib/python3.10/dist-packages (from sentence-transformers>=2.2.2->aac-metrics) (0.20.3)\n","Requirement already satisfied: Pillow in /usr/local/lib/python3.10/dist-packages (from sentence-transformers>=2.2.2->aac-metrics) (9.4.0)\n","Requirement already satisfied: filelock in /usr/local/lib/python3.10/dist-packages (from torch>=1.10.1->aac-metrics) (3.13.4)\n","Requirement already satisfied: typing-extensions>=4.8.0 in /usr/local/lib/python3.10/dist-packages (from torch>=1.10.1->aac-metrics) (4.11.0)\n","Requirement already satisfied: sympy in /usr/local/lib/python3.10/dist-packages (from torch>=1.10.1->aac-metrics) (1.12)\n","Requirement already satisfied: networkx in /usr/local/lib/python3.10/dist-packages (from torch>=1.10.1->aac-metrics) (3.3)\n","Requirement already satisfied: jinja2 in /usr/local/lib/python3.10/dist-packages (from torch>=1.10.1->aac-metrics) (3.1.3)\n","Requirement already satisfied: fsspec in /usr/local/lib/python3.10/dist-packages (from torch>=1.10.1->aac-metrics) (2023.6.0)\n","Requirement already satisfied: nvidia-cuda-nvrtc-cu12==12.1.105 in /usr/local/lib/python3.10/dist-packages (from torch>=1.10.1->aac-metrics) (12.1.105)\n","Requirement already satisfied: nvidia-cuda-runtime-cu12==12.1.105 in /usr/local/lib/python3.10/dist-packages (from torch>=1.10.1->aac-metrics) (12.1.105)\n","Requirement already satisfied: nvidia-cuda-cupti-cu12==12.1.105 in /usr/local/lib/python3.10/dist-packages (from torch>=1.10.1->aac-metrics) (12.1.105)\n","Requirement already satisfied: nvidia-cudnn-cu12==8.9.2.26 in /usr/local/lib/python3.10/dist-packages (from torch>=1.10.1->aac-metrics) (8.9.2.26)\n","Requirement already satisfied: nvidia-cublas-cu12==12.1.3.1 in /usr/local/lib/python3.10/dist-packages (from torch>=1.10.1->aac-metrics) (12.1.3.1)\n","Requirement already satisfied: nvidia-cufft-cu12==11.0.2.54 in /usr/local/lib/python3.10/dist-packages (from torch>=1.10.1->aac-metrics) (11.0.2.54)\n","Requirement already satisfied: nvidia-curand-cu12==10.3.2.106 in /usr/local/lib/python3.10/dist-packages (from torch>=1.10.1->aac-metrics) (10.3.2.106)\n","Requirement already satisfied: nvidia-cusolver-cu12==11.4.5.107 in /usr/local/lib/python3.10/dist-packages (from torch>=1.10.1->aac-metrics) (11.4.5.107)\n","Requirement already satisfied: nvidia-cusparse-cu12==12.1.0.106 in /usr/local/lib/python3.10/dist-packages (from torch>=1.10.1->aac-metrics) (12.1.0.106)\n","Requirement already satisfied: nvidia-nccl-cu12==2.19.3 in /usr/local/lib/python3.10/dist-packages (from torch>=1.10.1->aac-metrics) (2.19.3)\n","Requirement already satisfied: nvidia-nvtx-cu12==12.1.105 in /usr/local/lib/python3.10/dist-packages (from torch>=1.10.1->aac-metrics) (12.1.105)\n","Requirement already satisfied: triton==2.2.0 in /usr/local/lib/python3.10/dist-packages (from torch>=1.10.1->aac-metrics) (2.2.0)\n","Requirement already satisfied: nvidia-nvjitlink-cu12 in /usr/local/lib/python3.10/dist-packages (from nvidia-cusolver-cu12==11.4.5.107->torch>=1.10.1->aac-metrics) (12.4.127)\n","Requirement already satisfied: lightning-utilities>=0.8.0 in /usr/local/lib/python3.10/dist-packages (from torchmetrics>=0.11.4->aac-metrics) (0.11.2)\n","Requirement already satisfied: regex!=2019.12.17 in /usr/local/lib/python3.10/dist-packages (from transformers->aac-metrics) (2023.12.25)\n","Requirement already satisfied: requests in /usr/local/lib/python3.10/dist-packages (from transformers->aac-metrics) (2.31.0)\n","Requirement already satisfied: tokenizers<0.19,>=0.14 in /usr/local/lib/python3.10/dist-packages (from transformers->aac-metrics) (0.15.2)\n","Requirement already satisfied: safetensors>=0.4.1 in /usr/local/lib/python3.10/dist-packages (from transformers->aac-metrics) (0.4.2)\n","Requirement already satisfied: setuptools in /usr/local/lib/python3.10/dist-packages (from lightning-utilities>=0.8.0->torchmetrics>=0.11.4->aac-metrics) (67.7.2)\n","Requirement already satisfied: MarkupSafe>=2.0 in /usr/local/lib/python3.10/dist-packages (from jinja2->torch>=1.10.1->aac-metrics) (2.1.5)\n","Requirement already satisfied: charset-normalizer<4,>=2 in /usr/local/lib/python3.10/dist-packages (from requests->transformers->aac-metrics) (3.3.2)\n","Requirement already satisfied: idna<4,>=2.5 in /usr/local/lib/python3.10/dist-packages (from requests->transformers->aac-metrics) (3.6)\n","Requirement already satisfied: urllib3<3,>=1.21.1 in /usr/local/lib/python3.10/dist-packages (from requests->transformers->aac-metrics) (2.0.7)\n","Requirement already satisfied: certifi>=2017.4.17 in /usr/local/lib/python3.10/dist-packages (from requests->transformers->aac-metrics) (2024.2.2)\n","Requirement already satisfied: joblib>=1.1.1 in /usr/local/lib/python3.10/dist-packages (from scikit-learn->sentence-transformers>=2.2.2->aac-metrics) (1.4.0)\n","Requirement already satisfied: threadpoolctl>=2.0.0 in /usr/local/lib/python3.10/dist-packages (from scikit-learn->sentence-transformers>=2.2.2->aac-metrics) (3.4.0)\n","Requirement already satisfied: mpmath>=0.19 in /usr/local/lib/python3.10/dist-packages (from sympy->torch>=1.10.1->aac-metrics) (1.3.0)\n","[2024-04-13 18:27:57,584][aac_metrics.download][INFO] - aac-metrics download started.\n","[2024-04-13 18:27:57,584][aac_metrics.download][INFO] - Stanford model file 'stanford_nlp' is already downloaded.\n","[2024-04-13 18:27:57,584][aac_metrics.download][INFO] - Meteor file 'meteor' is already downloaded.\n","[2024-04-13 18:27:57,584][aac_metrics.download][INFO] - Meteor file 'meteor_data' is already downloaded.\n","[2024-04-13 18:27:57,584][aac_metrics.download][INFO] - Meteor file 'meteor_data_fr' is already downloaded.\n","[2024-04-13 18:27:57,584][aac_metrics.download][INFO] - Meteor file 'meteor_data_de' is already downloaded.\n","[2024-04-13 18:27:57,584][aac_metrics.download][INFO] - Meteor file 'meteor_data_es' is already downloaded.\n","[2024-04-13 18:27:57,584][aac_metrics.download][INFO] - Meteor file 'meteor_data_cz' is already downloaded.\n","[2024-04-13 18:27:57,584][aac_metrics.download][INFO] - Downloading SBERT and BERT error detector for FENSE metric...\n","[2024-04-13 18:28:08,080][aac_metrics.download][INFO] - Downloading BERT model for BERTScore metric...\n","[2024-04-13 18:28:16,964][aac_metrics.download][INFO] - aac-metrics download finished.\n"]}],"source":["!pip install aac-metrics\n","!aac-metrics-download\n","from aac_metrics import evaluate"]},{"cell_type":"markdown","metadata":{"id":"B8y5Ir2u9TKV"},"source":["## 2. Image Feature Prep"]},{"cell_type":"code","execution_count":null,"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"executionInfo":{"elapsed":576,"status":"ok","timestamp":1713032861334,"user":{"displayName":"Jac","userId":"11093024635147897716"},"user_tz":-540},"id":"mIrb2t08Fa6T","outputId":"0615670c-f47a-489f-ed09-8104baff8aea"},"outputs":[{"output_type":"stream","name":"stdout","text":["Total pokemon image =  829\n"]}],"source":["#check image count\n","imagename_df = pd.DataFrame(os.listdir(image_path))\n","imagename_df.columns = ['filename']\n","imagename_df['pokedex'] = imagename_df['filename'].str.replace('.png', \"\")\n","print(\"Total pokemon image = \", len(imagename_df))"]},{"cell_type":"markdown","metadata":{"id":"_-9h-hbOcKVl"},"source":["### Extract image feature with CNN: InceptionV3"]},{"cell_type":"code","execution_count":null,"metadata":{"id":"h0aQB73AcSOh"},"outputs":[],"source":["#function to extract features of images in the key list, stored in the image path\n","def extract_img_features(image_path, image_ids):\n","\n","  #load InceptionV3 model and restructure to remove the classification layer\n","  img_model = InceptionV3()\n","  img_model = Model(inputs=img_model.inputs, outputs=img_model.layers[-2].output)\n","\n","  #check model summary\n","  #print(img_model.summary())\n","\n","  # extract features for each image in the key list\n","  img_features = {}\n","\n","  for image_id in image_ids:\n","\n","    #read the image file\n","    full_path = image_path + '/' + str(image_id) + '.png'\n","\n","    #image preprocess for model\n","    image = load_img(full_path, target_size=(299, 299))\n","    image = img_to_array(image)\n","    image = image.reshape((1, image.shape[0], image.shape[1], image.shape[2]))\n","    image = preprocess_input(image)\n","\n","    #get feature and add to features dictionary\n","    img_feature = img_model.predict(image, verbose=0)\n","    img_features[image_id] = img_feature\n","\n","  return img_features"]},{"cell_type":"code","execution_count":null,"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"executionInfo":{"elapsed":88821,"status":"ok","timestamp":1713024045147,"user":{"displayName":"Jac","userId":"11093024635147897716"},"user_tz":-540},"id":"GEzQyUZYdRjF","outputId":"ba97e169-0efe-4f13-d6ca-84ffb3ce4321"},"outputs":[{"output_type":"stream","name":"stdout","text":["Downloading data from https://storage.googleapis.com/tensorflow/keras-applications/inception_v3/inception_v3_weights_tf_dim_ordering_tf_kernels.h5\n","96112376/96112376 [==============================] - 5s 0us/step\n"]}],"source":["# extracting image features for all pokemon images\n","pokemon_img_features = extract_img_features(image_path, imagename_df.pokedex.values)"]},{"cell_type":"code","execution_count":null,"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"executionInfo":{"elapsed":20,"status":"ok","timestamp":1713024045148,"user":{"displayName":"Jac","userId":"11093024635147897716"},"user_tz":-540},"id":"M9JZFvt31bCz","outputId":"62f0c388-8ad6-4386-c86c-b8c97f033898"},"outputs":[{"output_type":"stream","name":"stdout","text":["105 : [[ 3.3494558 20.61158   16.828089  ...  0.        29.466267   2.2700806]]\n","829\n"]}],"source":["#check\n","print(\"{} : {}\".format(list(pokemon_img_features.keys())[0], pokemon_img_features[list(pokemon_img_features.keys())[0]] ))\n","print(len(pokemon_img_features))"]},{"cell_type":"code","execution_count":null,"metadata":{"id":"nr7cgIm22UFS"},"outputs":[],"source":["#save the feature to file in drive\n","pickle.dump(pokemon_img_features, open(project_path+'pokemon_img_features.pkl', 'wb'))"]},{"cell_type":"code","execution_count":null,"metadata":{"id":"ZxjDGGehkzjI"},"outputs":[],"source":["#load the feature from file in drive\n","pokemon_img_features = pickle.load(open(project_path+'pokemon_img_features.pkl', 'rb'))"]}],"metadata":{"accelerator":"GPU","colab":{"gpuType":"A100","machine_shape":"hm","provenance":[]},"kernelspec":{"display_name":"Python 3","name":"python3"},"language_info":{"name":"python"}},"nbformat":4,"nbformat_minor":0}